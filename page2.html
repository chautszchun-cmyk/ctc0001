<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸ä¹˜æ³•å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
        body { font-family: 'Fredoka', sans-serif; }

        .input-box {
            transition: all 0.2s;
            border: 3px solid #E5E7EB;
        }
        .input-box:focus {
            outline: none;
            border-color: #3B82F6;
            transform: scale(1.05);
        }

        /* å‹•ç•«é¡åˆ¥ */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bounce {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        
        /* ç¶²æ ¼å‹•ç•« (èª¿æ…¢) */
        .grid-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: drawLine 2.5s forwards; /* å¾ 1s æ”¹ç‚º 2.5s */
        }
        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        /* å¡«å……å‹•ç•« (èª¿æ…¢) */
        .fill-anim {
            opacity: 0;
            animation: fadeInFill 1.5s forwards; /* å¾ 0.5s æ”¹ç‚º 1.5s */
        }
        @keyframes fadeInFill {
            to { opacity: 0.7; } /* Fill opacity */
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
    <div class="w-full max-w-4xl flex justify-between items-center mb-6">
        <div class="bg-white px-6 py-3 rounded-2xl shadow-md border-b-4 border-indigo-200">
            <span class="text-xl font-bold text-gray-600">å¾—åˆ†: <span id="score" class="text-indigo-600 text-3xl ml-2">0</span></span>
        </div>
        <div class="bg-white px-6 py-3 rounded-2xl shadow-md border-b-4 border-purple-200">
            <span class="text-xl font-bold text-gray-600">é¡Œè™Ÿ: <span id="question-count" class="text-purple-600 text-3xl ml-2">1</span></span>
        </div>
    </div>

    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-4xl flex flex-col md:flex-row gap-8 border-4 border-white">
        
        <!-- å·¦å´ï¼šè¦–è¦ºæ¼”ç¤ºå€ -->
        <div class="flex-1 flex flex-col items-center justify-center bg-gray-50 rounded-2xl p-4 border-2 border-dashed border-gray-300 relative">
            <h3 class="text-gray-500 font-bold mb-2 absolute top-4 left-4">è¦–è¦ºåŒ–æ¨¡å‹ (Area Model)</h3>
            
            <!-- é‡æ’­æŒ‰éˆ• -->
            <button onclick="drawModel(currentProblem)" class="absolute top-4 right-4 bg-white hover:bg-gray-100 text-gray-600 border border-gray-300 rounded-lg px-3 py-1 text-sm font-bold shadow-sm transition flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                é‡æ’­
            </button>
            
            <svg id="visual-svg" viewBox="0 0 400 350" class="w-full h-auto max-h-[300px] mt-8">
                <!-- èƒŒæ™¯ç™½æ¿ -->
                <rect x="10" y="40" width="380" height="280" rx="10" fill="white" stroke="#E5E7EB" stroke-width="2"/>
                
                <!-- ä¸»åœ–å½¢å®¹å™¨ -->
                <g id="model-container" transform="translate(50, 80)">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„å…§å®¹å°‡æ”¾åœ¨é€™è£¡ -->
                </g>

                <!-- æ¨™ç±¤ -->
                <text id="label-fraction1" x="200" y="70" text-anchor="middle" font-size="16" fill="#3B82F6" font-weight="bold"></text>
                <text id="label-fraction2" x="30" y="180" text-anchor="middle" font-size="16" fill="#EF4444" font-weight="bold" transform="rotate(-90 30 180)"></text>
            </svg>

            <div class="mt-4 flex gap-4 text-sm font-bold">
                <div class="flex items-center"><div class="w-4 h-4 bg-blue-400 opacity-70 mr-2 rounded"></div>åˆ†æ•¸ A</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-yellow-400 opacity-70 mr-2 rounded"></div>åˆ†æ•¸ B</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-green-500 opacity-90 mr-2 rounded"></div>é‡ç–Šå€åŸŸ (ç­”æ¡ˆ)</div>
            </div>
        </div>

        <!-- å³å´ï¼šé¡Œç›®èˆ‡ä½œç­”å€ -->
        <div class="flex-1 flex flex-col justify-center items-center relative">
            
            <!-- é¡Œç›®é¡¯ç¤º -->
            <div class="text-5xl font-bold text-gray-800 mb-8 flex items-center gap-4 fade-in-up">
                <div class="flex flex-col items-center">
                    <span id="num1" class="border-b-4 border-gray-800 px-2 min-w-[40px] text-center">1</span>
                    <span id="den1" class="px-2 min-w-[40px] text-center">2</span>
                </div>
                <span class="text-gray-400">Ã—</span>
                <div class="flex flex-col items-center">
                    <span id="num2" class="border-b-4 border-gray-800 px-2 min-w-[40px] text-center">1</span>
                    <span id="den2" class="px-2 min-w-[40px] text-center">3</span>
                </div>
                <span class="text-gray-400">=</span>
                <!-- ç­”æ¡ˆè¼¸å…¥æ¡† -->
                <div class="flex flex-col items-center relative">
                    <input type="number" id="ans-num" class="input-box text-center text-3xl font-bold w-20 h-16 rounded-t-lg bg-gray-50 text-indigo-600 focus:bg-white" placeholder="?">
                    <div class="w-full h-1 bg-gray-800 my-1"></div>
                    <input type="number" id="ans-den" class="input-box text-center text-3xl font-bold w-20 h-16 rounded-b-lg bg-gray-50 text-indigo-600 focus:bg-white" placeholder="?">
                    
                    <!-- æµ®å‹•æç¤º -->
                    <div id="simplify-hint" class="hidden absolute -right-32 top-1/2 -translate-y-1/2 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded shadow border border-yellow-300">
                        è©¦è©¦ç´„åˆ†!
                    </div>
                </div>
            </div>

            <!-- æŒ‰éˆ•å€ -->
            <div class="flex gap-4 w-full">
                <button id="btn-check" onclick="checkAnswer()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-6 rounded-2xl shadow-lg transition transform active:scale-95">
                    æäº¤ç­”æ¡ˆ
                </button>
                <button id="btn-next" onclick="nextQuestion()" class="hidden flex-1 bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-4 px-6 rounded-2xl shadow-lg transition transform active:scale-95">
                    ä¸‹ä¸€é¡Œ âœ
                </button>
            </div>

            <!-- å›é¥‹è¨Šæ¯ -->
            <div id="feedback" class="mt-6 min-h-[60px] text-center">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- èªªæ˜æ–‡å­— -->
            <div class="mt-auto pt-8 text-gray-400 text-sm text-center">
                æç¤ºï¼šæ•¸ä¸€æ•¸ç¶ è‰²çš„æ ¼å­æ˜¯åˆ†å­ï¼Œç¸½æ ¼å­æ•¸æ˜¯åˆ†æ¯ã€‚
            </div>
        </div>
    </div>

    <!-- Firebase æ¨¡æ“¬ -->
    <script>
        const __app_id = 'fraction-game-app';
        const __firebase_config = '{}';
        const __initial_auth_token = undefined;
    </script>

    <script>
        // éŠæˆ²ç‹€æ…‹
        let currentProblem = {};
        let score = 0;
        let qCount = 0;
        let isAnswered = false;

        // DOM å…ƒç´ 
        const elNum1 = document.getElementById('num1');
        const elDen1 = document.getElementById('den1');
        const elNum2 = document.getElementById('num2');
        const elDen2 = document.getElementById('den2');
        const elAnsNum = document.getElementById('ans-num');
        const elAnsDen = document.getElementById('ans-den');
        const elScore = document.getElementById('score');
        const elQCount = document.getElementById('question-count');
        const elFeedback = document.getElementById('feedback');
        const btnCheck = document.getElementById('btn-check');
        const btnNext = document.getElementById('btn-next');
        const modelContainer = document.getElementById('model-container');
        const lblFrac1 = document.getElementById('label-fraction1');
        const lblFrac2 = document.getElementById('label-fraction2');
        const simplifyHint = document.getElementById('simplify-hint');

        // éŸ³æ•ˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // æ•¸å­¸å·¥å…·ï¼šæœ€å¤§å…¬å› æ•¸
        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        // ç”Ÿæˆæ–°é¡Œç›®
        function generateProblem() {
            // éš¨æ©Ÿç”Ÿæˆåˆ†æ¯ (2-6ï¼Œé¿å…åœ–å½¢å¤ªè¤‡é›œ)
            const den1 = Math.floor(Math.random() * 4) + 2; 
            const den2 = Math.floor(Math.random() * 4) + 2; 

            // ç”ŸæˆçœŸåˆ†æ•¸çš„åˆ†å­
            const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
            const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;

            return {
                f1: { n: num1, d: den1 },
                f2: { n: num2, d: den2 }
            };
        }

        // ç¹ªè£½ SVG æ¨¡å‹
        function drawModel(p) {
            modelContainer.innerHTML = ''; // æ¸…ç©º
            
            const w = 300;
            const h = 200;
            const colW = w / p.f1.d;
            const rowH = h / p.f2.d;

            // 1. ç¹ªè£½èƒŒæ™¯ç¶²æ ¼ (ç¸½æ ¼å­)
            // å…ˆç•«å¤–æ¡†
            const border = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            border.setAttribute("width", w);
            border.setAttribute("height", h);
            border.setAttribute("fill", "white");
            border.setAttribute("stroke", "#9CA3AF");
            border.setAttribute("stroke-width", "2");
            modelContainer.appendChild(border);

            // 2. å‚ç›´åˆ†å‰² (åˆ†æ•¸ A - è—è‰²)
            // é€™è£¡ç•«å‡ºå¡«æ»¿çš„éƒ¨åˆ†
            for (let i = 0; i < p.f1.n; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", i * colW);
                rect.setAttribute("y", 0);
                rect.setAttribute("width", colW);
                rect.setAttribute("height", h);
                rect.setAttribute("fill", "#60A5FA"); // Blue-400
                rect.setAttribute("class", "fill-anim");
                rect.setAttribute("stroke", "none");
                modelContainer.appendChild(rect);
            }

            // å‚ç›´ç¶²æ ¼ç·š (ç•«åœ¨æœ€ä¸Šå±¤)
            for (let i = 1; i < p.f1.d; i++) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", i * colW);
                line.setAttribute("y1", 0);
                line.setAttribute("x2", i * colW);
                line.setAttribute("y2", h);
                line.setAttribute("stroke", "#2563EB"); // Darker Blue
                line.setAttribute("stroke-width", "2");
                line.setAttribute("stroke-dasharray", "4 2");
                line.setAttribute("class", "grid-line");
                // å»¶é²ä¸€é»é»ï¼Œç­‰è—è‰²å€å¡Šé–‹å§‹å¡«è‰²å¾Œå†ç•«ç·š
                line.style.animationDelay = "0.5s"; // èª¿æ…¢ï¼š0.2s -> 0.5s
                modelContainer.appendChild(line);
            }

            // 3. æ°´å¹³åˆ†å‰² (åˆ†æ•¸ B - é»ƒè‰²åŠé€æ˜)
            // é€™è£¡ç•«å‡ºå¡«æ»¿çš„éƒ¨åˆ†
            for (let j = 0; j < p.f2.n; j++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", 0);
                rect.setAttribute("y", j * rowH);
                rect.setAttribute("width", w);
                rect.setAttribute("height", rowH);
                rect.setAttribute("fill", "#FBBF24"); // Yellow-400
                rect.setAttribute("fill-opacity", "0.5"); // åŠé€æ˜ä»¥é¡¯ç¤ºé‡ç–Š
                rect.setAttribute("class", "fill-anim");
                // é¡¯è‘—å»¶é²ï¼Œç­‰å¾…å‚ç›´éƒ¨åˆ†å®Œå…¨æ¼”ç¤ºå®Œç•¢
                rect.style.animationDelay = "2s"; // èª¿æ…¢ï¼š0.5s -> 2s
                modelContainer.appendChild(rect);
            }

            // æ°´å¹³ç¶²æ ¼ç·š
            for (let j = 1; j < p.f2.d; j++) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", 0);
                line.setAttribute("y1", j * rowH);
                line.setAttribute("x2", w);
                line.setAttribute("y2", j * rowH);
                line.setAttribute("stroke", "#D97706"); // Darker Yellow
                line.setAttribute("stroke-width", "2");
                line.setAttribute("stroke-dasharray", "4 2");
                line.setAttribute("class", "grid-line");
                // å†å»¶é²ï¼Œç¢ºä¿é»ƒè‰²å¡«è‰²å¾Œæ‰ç•«ç·š
                line.style.animationDelay = "3s"; // èª¿æ…¢ï¼š0.7s -> 3s
                modelContainer.appendChild(line);
            }

            // 4. å¼·èª¿é‡ç–Šå€åŸŸ (ç¶ è‰²)
            // é€™æ˜¯ç­”æ¡ˆçš„åˆ†å­éƒ¨åˆ†
            // æœ€å¾Œæ‰é¡¯ç¤º
            setTimeout(() => {
                for (let i = 0; i < p.f1.n; i++) {
                    for (let j = 0; j < p.f2.n; j++) {
                        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        rect.setAttribute("x", i * colW + 2); // padding
                        rect.setAttribute("y", j * rowH + 2);
                        rect.setAttribute("width", colW - 4);
                        rect.setAttribute("height", rowH - 4);
                        rect.setAttribute("fill", "#22C55E"); // Green-500
                        rect.setAttribute("fill-opacity", "0");
                        
                        // è½‰å ´ä¹Ÿè®Šæ…¢
                        rect.style.transition = "fill-opacity 1.5s"; // èª¿æ…¢ï¼š0.5s -> 1.5s
                        modelContainer.appendChild(rect);
                        
                        // Trigger reflow
                        rect.getBoundingClientRect();
                        rect.setAttribute("fill-opacity", "0.8");
                    }
                }
            }, 5000); // èª¿æ…¢ï¼š1000ms -> 5000ms (5ç§’å¾Œæ‰é¡¯ç¤ºç­”æ¡ˆå€åŸŸ)

            // æ›´æ–°æ¨™ç±¤
            lblFrac1.textContent = `ç›´è¡Œåˆ†å‰²: ${p.f1.n}/${p.f1.d}`;
            lblFrac2.textContent = `æ©«åˆ—åˆ†å‰²: ${p.f2.n}/${p.f2.d}`;
        }

        // åˆå§‹åŒ–ä¸€é¡Œ
        function nextQuestion() {
            currentProblem = generateProblem();
            qCount++;
            isAnswered = false;

            // Update UI
            elQCount.textContent = qCount;
            elNum1.textContent = currentProblem.f1.n;
            elDen1.textContent = currentProblem.f1.d;
            elNum2.textContent = currentProblem.f2.n;
            elDen2.textContent = currentProblem.f2.d;
            
            // Clear inputs
            elAnsNum.value = '';
            elAnsDen.value = '';
            elAnsNum.disabled = false;
            elAnsDen.disabled = false;
            elAnsNum.focus();

            // Clear feedback
            elFeedback.innerHTML = '';
            simplifyHint.classList.add('hidden');

            // Reset buttons
            btnCheck.classList.remove('hidden');
            btnNext.classList.add('hidden');

            // Draw SVG
            drawModel(currentProblem);
        }

        // æª¢æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            const userNum = parseInt(elAnsNum.value);
            const userDen = parseInt(elAnsDen.value);

            if (isNaN(userNum) || isNaN(userDen)) {
                elFeedback.innerHTML = `<span class="text-red-500 font-bold">è«‹è¼¸å…¥å®Œæ•´çš„åˆ†å­å’Œåˆ†æ¯ï¼</span>`;
                playSound('wrong');
                return;
            }

            // æ­£ç¢ºç­”æ¡ˆ (æœªç´„åˆ†)
            const correctNumRaw = currentProblem.f1.n * currentProblem.f2.n;
            const correctDenRaw = currentProblem.f1.d * currentProblem.f2.d;

            // æ­£ç¢ºç­”æ¡ˆ (æœ€ç°¡åˆ†æ•¸)
            const commonDivisor = gcd(correctNumRaw, correctDenRaw);
            const correctNumSimp = correctNumRaw / commonDivisor;
            const correctDenSimp = correctDenRaw / commonDivisor;

            let isCorrect = false;
            let points = 0;
            let message = "";

            if (userNum === correctNumSimp && userDen === correctDenSimp) {
                // æœ€ç°¡åˆ†æ•¸ (å®Œç¾)
                isCorrect = true;
                points = 100;
                message = `å¤ªæ£’äº†ï¼ç­”å°äº†ä¸”æ˜¯æœ€ç°¡åˆ†æ•¸ï¼(+100åˆ†)`;
                if (correctNumRaw !== correctNumSimp) {
                    message = `å¤ªå²å®³äº†ï¼ä½ ç›´æ¥ç®—å‡ºäº†æœ€ç°¡åˆ†æ•¸ï¼(+100åˆ†)`;
                }
            } else if (userNum === correctNumRaw && userDen === correctDenRaw) {
                // æœªç´„åˆ† (æ­£ç¢º)
                isCorrect = true;
                points = 80; // ç¨å¾®å°‘ä¸€é»åˆ†
                message = `ç­”å°äº†ï¼(+80åˆ†)`;
                if (correctNumRaw !== correctNumSimp) {
                     message += `<br><span class="text-sm text-yellow-600">ğŸ’¡ æç¤ºï¼šé€™å€‹ç­”æ¡ˆé‚„å¯ä»¥ç´„åˆ†å–” (${correctNumSimp}/${correctDenSimp})ï¼Œç´„åˆ†å¯ä»¥æ‹¿æ»¿åˆ†ï¼</span>`;
                     simplifyHint.classList.remove('hidden');
                }
            } else {
                // éŒ¯èª¤
                isCorrect = false;
                message = `å†è©¦è©¦çœ‹ï¼<br>æç¤ºï¼šåˆ†å­ä¹˜åˆ†å­ (${currentProblem.f1.n}Ã—${currentProblem.f2.n})ï¼Œåˆ†æ¯ä¹˜åˆ†æ¯ (${currentProblem.f1.d}Ã—${currentProblem.f2.d})`;
            }

            if (isCorrect) {
                playSound('correct');
                score += points;
                elScore.textContent = score;
                elFeedback.innerHTML = `<span class="text-green-600 font-bold text-xl bounce inline-block">âœ… ${message}</span>`;
                
                // é–å®šè¼¸å…¥
                elAnsNum.disabled = true;
                elAnsDen.disabled = true;
                isAnswered = true;

                // åˆ‡æ›æŒ‰éˆ•
                btnCheck.classList.add('hidden');
                btnNext.classList.remove('hidden');
                btnNext.focus();
            } else {
                playSound('wrong');
                elFeedback.innerHTML = `<span class="text-red-500 font-bold text-lg shake">âŒ ${message}</span>`;
                
                // éŒ¯èª¤å‹•ç•«
                const inputs = [elAnsNum, elAnsDen];
                inputs.forEach(el => {
                    el.classList.add('border-red-500');
                    setTimeout(() => el.classList.remove('border-red-500'), 500);
                });
            }
        }

        // æ”¯æ´ Enter éµæäº¤
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (!isAnswered) {
                    checkAnswer();
                } else if (!btnNext.classList.contains('hidden')) {
                    nextQuestion();
                }
            }
        });

        // Start game
        window.onload = nextQuestion;

    </script>
</body>
</html>
